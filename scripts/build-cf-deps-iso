#!/usr/bin/env bash
set -euxo pipefail

if [[ $# -lt 2 ]]; then
  echo "USAGE: ./build-cf-iso [path to tar]..."
  exit 1
fi

tars=$@
script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
output_dir="$script_dir/../output"
iso_file="$output_dir"/cf-deps.iso

rm -rf "$iso_file"
mkdir -p "$output_dir"
iso_dir="$(mktemp -d)"
trap cleanup EXIT

cleanup() {
  rm -rf "$iso_dir"
}

build() {
  "$script_dir"/../images/cf/build.sh
}

export() {
  # Place the 'workspace' container image
  cid=$(docker run -d pivotal/cf sleep infinity)
  docker export "$cid" > "${iso_dir}/workspace.tar"
  docker kill "$cid"
  docker rm "$cid"
}

add_deps(){
  for tar in $tars; do
    tar xzf "$tar" -C $iso_dir
  done
}

make_iso() {
  mkisofs -V cf-deps -R -o "$iso_file" "$iso_dir"
}

main () {
  build
  export
  add_deps
  make_iso
}

main
